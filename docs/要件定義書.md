# かんたんBIツール 要件定義書

- プロジェクト名: かんたんBIツール（仮: LightBI）
- バージョン: v0.1（MVP）
- 作成日: 2025-12-25
- 参照資料:
  - [BIツールについて.md](BIツールについて.md)
  - [開発手順/1_DB設計(テーブル構成).md](開発手順/1_DB設計(テーブル構成).md)
  - [開発手順/2_NestJS API設計(SQL実行・保存).md](開発手順/2_NestJS API設計(SQL実行・保存).md)
  - [開発手順/3_フロントでのWidget描画構造(React).md](開発手順/3_フロントでのWidget描画構造(React).md)
  - [開発手順/4_SQL実行の安全設計(実装レベル).md](開発手順/4_SQL実行の安全設計(実装レベル).md)
  - [開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md](開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md)
  - [開発手順/6_OSSとの差別化ポイント.md](開発手順/6_OSSとの差別化ポイント.md)
  - [開発手順/7_SaaS化を見据えた最小設計.md](開発手順/7_SaaS化を見据えた最小設計.md)
  - [開発手順/8_ポートフォリオとしての見せ方(README-デモ).md](開発手順/8_ポートフォリオとしての見せ方(README-デモ).md)
  - [開発手順/9_実際に使われるための“1機能”追加.md](開発手順/9_実際に使われるための“1機能”追加.md)
  - [開発手順/10_リリース＆運用の最小手順.md](開発手順/10_リリース＆運用の最小手順.md)

---

## 1. 背景・目的

業務で日常的に行われる「Excel/CSVベースの集計・可視化」を、最小コストで安全に、かつ素早く実現するための軽量BIツールを提供する。既存OSS（Metabase/Redash/Superset等）は多機能で強力だが、初期導入や運用が重く、個人・小規模チームには過剰なことが多い。本プロジェクトは「SQLが書ける人」向けに機能を絞り、爆速・安全・シンプルな体験を目指す。

- 目的: SQLファーストの軽量BIを最小構成で提供し、実務で即使える価値を出す
- 成果物: フロント（React）＋API（NestJS）＋DB（PostgreSQL）のMVP一式

---

## 2. スコープ

- 対象範囲（MVP）
  - データソース接続管理（まずはPostgreSQL）
  - SQL管理・保存
  - SQL実行（安全設計）→ 表形式/簡易チャート表示（折れ線/棒/テーブル）
  - ダッシュボード・ウィジェット管理（配置/サイズ/設定保存）
  - 共通フィルタ（日付など）の適用
  - CSVアップロード→テーブル自動生成→サンプルSQL自動作成→即可視化
  - 認証（簡易JWT）

- 非対象（非目標／後回し）
  - ノーコードクエリビルダー
  - 多DB同時対応（初期はPostgreSQLのみ）
  - リアルタイム可視化／ストリーミング
  - 大規模RBAC／共有リンク／複数ユーザー本格運用

---

## 3. 利用者・ペルソナ

- エンジニア／データ担当者（SQLが書ける）
- 小規模チームの担当者（Excel/CSVで集計しているが、BI導入ハードルが高い）

主な価値:
- SQLを書けばすぐに可視化/ダッシュボード化できる
- CSVからでも高速に試せる（セットアップ不要）

---

## 4. ユースケース

1. 既存PostgreSQLに接続し、クエリを保存→表/グラフを作成→ダッシュボードに配置
2. CSVをアップロード→テーブル自動生成→サンプルSQLが自動登録→即グラフ化
3. ダッシュボードで期間フィルタを変更→関連ウィジェットが一括再実行
4. 「定例」に使うダッシュボードを閲覧→軽快に更新・再配置

---

## 5. 差別化コンセプト（思想）

- SQLファースト／爆速体験（ページ遷移最小、保存→即可視化）
- 最小UI・設定（グラフは3種、必要十分な機能のみ）
- CSV一発デモ体験（「試すまで数十秒」）
- 安全性重視（read-only、SELECT限定、LIMIT/timeout、プリペアド）

参考: [開発手順/6_OSSとの差別化ポイント.md](開発手順/6_OSSとの差別化ポイント.md)

---

## 6. システム構成（MVP）

- フロントエンド: React + TypeScript（ECharts/React-Grid-Layout/TanStack Query）
- バックエンド: NestJS（REST、JWT）
- データベース: PostgreSQL（read-onlyユーザー運用）
- 実行フロー: Dashboard → Widget（`queryId` + `config`）→ Execute API → data → Chart

参考: [開発手順/2_NestJS API設計(SQL実行・保存).md](開発手順/2_NestJS API設計(SQL実行・保存).md), [開発手順/3_フロントでのWidget描画構造(React).md](開発手順/3_フロントでのWidget描画構造(React).md)

---

## 7. 機能要件

### 7.1 認証
- 方式: JWT（最小）、`userId` をトークンに含める
- 対応API: `/auth/login`, `/auth/register`

### 7.2 データソース管理
- 登録/一覧/削除: `/data-sources`
- 暗号化保存（接続情報）
- 接続テスト機能
- 初期対応: PostgreSQL

### 7.3 クエリ管理
- CRUD: `/queries`
- フィールド: `id`, `name`, `sql`, `parameters(json)`, `data_source_id`
- フィルタパラメータ設計（`{{from}}`, `{{to}}` 等）

### 7.4 実行（Execute）
- エンドポイント: `POST /execute`（`queryId`, `params`）
- 責務: SQL取得→パラメータバインド→安全チェック→タイムアウト/行制限→結果返却
- ログ記録（`query_executions`: `duration_ms`, `row_count`）

### 7.5 ダッシュボード管理
- CRUD: `/dashboards`
- 表示順・名称管理

### 7.6 ウィジェット管理
- CRUD: `/widgets`
- フィールド: `dashboard_id`, `query_id`, `type('table'|'line'|'bar')`, `config(json)`, `position(x,y,w,h)`
- フロント: `react-grid-layout`で配置/サイズ管理

### 7.7 フィルタ
- 共通フィルタ（期間/カテゴリ等）をDashboardコンテキストで保持→Widgetの実行に渡す

### 7.8 CSVアップロード（「1機能」）
- API: `POST /csv/upload`（multipart）
- 機能: 型推定→テーブル自動生成（専用スキーマ）→データ投入→サンプルSQL自動作成→即ダッシュボード反映
- 制限: サイズ（例10MB）、行数、専用DBユーザー、テナント別プレフィックス

参考: [開発手順/9_実際に使われるための“1機能”追加.md](開発手順/9_実際に使われるための“1機能”追加.md)

---

## 8. 非機能要件

### 8.1 セキュリティ
- DB: read-onlyユーザー、`statement_timeout` 設定
- API: `SELECT`限定、危険キーワード遮断、プリペアドステートメントでバインド
- 行制限: `LIMIT`強制（例10,000行）
- 実行タイムアウト: API側5秒程度（調整可能）

参考: [開発手順/4_SQL実行の安全設計(実装レベル).md](開発手順/4_SQL実行の安全設計(実装レベル).md)

### 8.2 性能
- DB接続プール利用
- 重いクエリの可視化（実行ログ）
- キャッシュ（将来検討、MVPでは不要）

### 8.3 可用性・運用最小化
- 目的: 「第三者が5分以内に触れる」
- 推奨構成: Frontend=Vercel, Backend=Fly.io/Railway, DB=Managed PostgreSQL
- デモデータ/初期ダッシュボードを同梱

参考: [開発手順/10_リリース＆運用の最小手順.md](開発手順/10_リリース＆運用の最小手順.md)

### 8.4 拡張性（SaaSの芽）
- `tenants` テーブルを導入（将来拡張用）
- 主要テーブルに `tenant_id` を持たせる（MVPでは固定値で運用）
- ステートレス設計（API水平分割に耐える）

参考: [開発手順/7_SaaS化を見据えた最小設計.md](開発手順/7_SaaS化を見据えた最小設計.md)

---

## 9. データモデル（MVP）

- `users`: `id`, `email`, `password_hash`, `created_at`
- `data_sources`: `id`, `name`, `type`, `host`, `port`, `database`, `username`, `encrypted_password`, `created_at`
- `queries`: `id`, `name`, `sql`, `parameters(jsonb)`, `data_source_id`, `created_at`, `updated_at`
- `dashboards`: `id`, `name`, `created_at`
- `widgets`: `id`, `dashboard_id`, `query_id`, `type`, `config(jsonb)`, `position_x`, `position_y`, `width`, `height`
- `query_executions`: `id`, `query_id`, `executed_at`, `duration_ms`, `row_count`
- （将来）`tenants`: `id`, `name`, `plan`, `limits`

参考: [開発手順/1_DB設計(テーブル構成).md](開発手順/1_DB設計(テーブル構成).md)

---

## 10. API要約（代表例）

- 認証: `POST /auth/login`, `POST /auth/register`
- データソース: `POST /data-sources`, `GET /data-sources`, `DELETE /data-sources/:id`
- クエリ: `POST /queries`, `GET /queries/:id`, `PUT /queries/:id`, `DELETE /queries/:id`
- 実行: `POST /execute`（`{ queryId, params }`）
- ダッシュボード: `POST /dashboards`, `GET /dashboards`, `DELETE /dashboards/:id`
- ウィジェット: `POST /widgets`, `PUT /widgets/:id`, `DELETE /widgets/:id`
- CSV: `POST /csv/upload`

参考: [開発手順/2_NestJS API設計(SQL実行・保存).md](開発手順/2_NestJS API設計(SQL実行・保存).md)

---

## 11. UI/UX要件

- Widgetコンポーネント分割（Container/Header/Content/Renderer）
- Chart共通IF: `data: Record<string, any>[]`, `config: { xKey?: string; yKeys?: string[] }`
- チャート種類（MVP）: `table`, `line`, `bar`
- ダッシュボード: `react-grid-layout` による位置/サイズ管理
- フィルタ: Dashboard単位のコンテキストで保持、再実行トリガ

参考: [開発手順/3_フロントでのWidget描画構造(React).md](開発手順/3_フロントでのWidget描画構造(React).md)

---

## 12. 技術スタック・依存

- Frontend: React + TypeScript, ECharts, React-Grid-Layout, TanStack Query
- Backend: NestJS + TypeScript, pg/Prisma, JWT
- DB: PostgreSQL（read-onlyユーザー）
- コンテナ: Docker（デモ起動用）

参考: [開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md](開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md)

---

## 13. MVP完成条件（受入基準）

- SQL実行が安全に動作（`SELECT`限定／`LIMIT`／timeout／パラメータバインド）
- 表/グラフが表示される（`line`/`bar`/`table`）
- クエリ/ダッシュボード/ウィジェットが保存・再現可能
- CSVアップロード→自動化フローが機能する
- デモ環境で第三者が5分以内に触れる

---

## 14. リスクと対策

- 重いSQLによる応答遅延 → `LIMIT`/`timeout`/ログで検出、クエリ制限
- SQLインジェクション → プリペアドステートメント必須、危険キーワード遮断
- デモ運用の不安定さ → マネージドDB/軽量PaaSを採用、READMEに免責記載

---

## 15. 今後の展望（ロードマップ）

- Phase 1（MVP）: SQL実行、グラフ1-2種、保存、CSVアップロード
- Phase 2: ダッシュボード強化、フィルタ、共有（限定）
- Phase 3: 権限/RBAC（軽量）、キャッシュ、SaaS対応（tenant本格運用、課金）

参考: [BIツールについて.md](BIツールについて.md), [開発手順/7_SaaS化を見据えた最小設計.md](開発手順/7_SaaS化を見据えた最小設計.md)

---

## 16. ポートフォリオ・公開方針

- READMEに思想/設計/デモGIF/起動手順を明記
- デモ用データ/初期ダッシュボードを同梱
- 免責: デモ用途、SLAなし

参考: [開発手順/8_ポートフォリオとしての見せ方(README-デモ).md](開発手順/8_ポートフォリオとしての見せ方(README-デモ).md), [開発手順/10_リリース＆運用の最小手順.md](開発手順/10_リリース＆運用の最小手順.md)

---

以上。MVPの要件は「SQLファースト」「CSV一発体験」「安全設計」の3本柱で構成し、個人開発でも短期で成立させる。後方互換性を意識して `tenant_id` などの拡張点を先に仕込むが、当面は単一テナントで運用する。