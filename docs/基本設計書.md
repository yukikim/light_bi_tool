# かんたんBIツール 基本設計書

- プロジェクト名: かんたんBIツール（LightBI）
- バージョン: v0.1（MVP）
- 作成日: 2025-12-25
- 前提: 要件は [個人開発案件/かんたんBIツール_要件定義書.md](かんたんBIツール_要件定義書.md) を参照
- 参照資料:
  - [BIツールについて.md](BIツールについて.md)
  - [開発手順/1_DB設計(テーブル構成).md](開発手順/1_DB設計(テーブル構成).md)
  - [開発手順/2_NestJS API設計(SQL実行・保存).md](開発手順/2_NestJS API設計(SQL実行・保存).md)
  - [開発手順/3_フロントでのWidget描画構造(React).md](開発手順/3_フロントでのWidget描画構造(React).md)
  - [開発手順/4_SQL実行の安全設計(実装レベル).md](開発手順/4_SQL実行の安全設計(実装レベル).md)
  - [開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md](開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md)
  - [開発手順/6_OSSとの差別化ポイント.md](開発手順/6_OSSとの差別化ポイント.md)
  - [開発手順/7_SaaS化を見据えた最小設計.md](開発手順/7_SaaS化を見据えた最小設計.md)
  - [開発手順/8_ポートフォリオとしての見せ方(README-デモ).md](開発手順/8_ポートフォリオとしての見せ方(README-デモ).md)
  - [開発手順/9_実際に使われるための“1機能”追加.md](開発手順/9_実際に使われるための“1機能”追加.md)
  - [開発手順/10_リリース＆運用の最小手順.md](開発手順/10_リリース＆運用の最小手順.md)

---

## 1. 目的・範囲（基本設計のねらい）

- 目的: 要件に基づき、MVPを短期間で安全に作り切るための構造・インターフェース・フローを具体化する。
- 範囲: フロント（React）/ バックエンド（NestJS）/ DB（PostgreSQL）/ CSVアップロードの「1機能」/ 安全設計 / 運用最低限。

---

## 2. 全体アーキテクチャ

```text
[ React (TypeScript) ]
  - Dashboard / Widgets / Charts
  - Filters (Context/Zustand)
  - API Client (fetch)
        ↓ HTTP(JSON)
[ NestJS API ]
  - Auth / DataSources / Queries / Dashboards / Widgets / Execute / CSV
        ↓
[ PostgreSQL ]
  - Read-only user + statement_timeout
```

- 通信: REST(JSON)
- 認証: JWT（MVP）
- 安全設計: API/DBの多重防御（詳細は §7）

---

## 3. モジュール構成（バックエンド）

```
src/
├─ auth/              （JWT発行・検証）
├─ users/             （必要最小のユーザーCRUD）
├─ data-sources/      （接続先DBの登録・暗号化保存・接続テスト）
├─ queries/           （SQL・パラメータ定義のCRUD）
├─ dashboards/        （ダッシュボード定義CRUD）
├─ widgets/           （ウィジェット定義CRUD）
├─ execute/           （SQL実行専用モジュール：安全設計の中核）
├─ csv/               （CSVアップロード→テーブル生成→サンプルSQL登録）
└─ prisma/            （Prismaまたはpgドライバ定義）
```

- 責務分離: `execute` をCRUDから分離し、クエリ実行の安全制御を集約。
- 依存: DB接続はプール化。SQLはプリペアドステートメントでバインド。

---

## 4. コンポーネント構成（フロントエンド）

```
App
 ├─ Pages
 │   ├─ DashboardList
 │   └─ DashboardDetail
 ├─ Components
 │   ├─ Widget
 │   │   ├─ WidgetContainer（枠/ローディング/エラー）
 │   │   ├─ WidgetHeader（タイトル/再実行/設定）
 │   │   ├─ WidgetContent（API呼び出し）
 │   │   └─ WidgetRenderer（table/line/barの描画切替）
 │   ├─ Charts（LineChart/BarChart/Table）
 │   └─ Filters（DashboardスコープのフィルタUI）
 └─ api/ (execute/queries/widgets等)
```

- 状態管理: TanStack Query（データ取得）、FiltersはContextまたはZustand。
- レイアウト: `react-grid-layout` で `position(x,y,w,h)` を保存・復元。
- チャートIF:
```ts
interface ChartProps {
  data: Record<string, any>[];
  config: { xKey?: string; yKeys?: string[] };
}
```

---

## 5. データ設計（MVP）

- 主要テーブル（詳細は [開発手順/1_DB設計(テーブル構成).md](開発手順/1_DB設計(テーブル構成).md)）
  - `users(id, email, password_hash, created_at)`
  - `data_sources(id, name, type, host, port, database, username, encrypted_password, created_at)`
  - `queries(id, name, sql, parameters(jsonb), data_source_id, created_at, updated_at)`
  - `dashboards(id, name, created_at)`
  - `widgets(id, dashboard_id, query_id, type, config(jsonb), position_x, position_y, width, height)`
  - `query_executions(id, query_id, executed_at, duration_ms, row_count)`
  - （将来）`tenants(id, name, plan, limits)` と主要テーブルの `tenant_id`

- CSV用テーブル: 専用スキーマ（例 `csv_schema`）に `csv_XXXX` を作成。列型はアップロード時に推定。

---

## 6. API設計（IF定義）

- 認証
  - `POST /auth/register` { email, password }
  - `POST /auth/login` { email, password } → { token }

- データソース
  - `POST /data-sources` { name, type, config }
  - `GET /data-sources` → list
  - `DELETE /data-sources/:id`
  - `POST /data-sources/test` { config } → { ok: boolean }

- クエリ
  - `POST /queries` { name, sql, parameters?, dataSourceId }
  - `GET /queries/:id`
  - `PUT /queries/:id`
  - `DELETE /queries/:id`

- 実行
  - `POST /execute` { queryId, params } → { columns, rows }
    - 例外: 400（不正SQL/不足パラメータ）, 408（タイムアウト）, 429（行数超過）

- ダッシュボード
  - `POST /dashboards`, `GET /dashboards`, `DELETE /dashboards/:id`

- ウィジェット
  - `POST /widgets` { dashboardId, queryId, type, config, position }
  - `PUT /widgets/:id`
  - `DELETE /widgets/:id`

- CSVアップロード
  - `POST /csv/upload` (multipart: file)
    - 処理: 型推定→`csv_schema.csv_<name>` 生成→COPY投入→サンプルSQL保存→応答に新規`queryId`/`widgetId`を含める

- レスポンス共通
  - 成功: `{ data, meta }` / 失敗: `{ error: { code, message } }`

---

## 7. 安全設計（実装レベル）

- DB側
  - Read-onlyユーザー（SELECTのみ権限）
  - `statement_timeout`（例: 5s）
- API側
  - `SELECT`限定チェック（先頭が`select`）
  - 危険キーワード遮断（`insert|update|delete|drop|alter|truncate|create`）
  - パラメータは必ずプリペアドステートメントでバインド
  - 行数制限（`LIMIT`強制、例 10,000行）
  - 実行タイムアウト（例: 5s）
  - 実行ログ保存（`query_executions`）
- 参照: [開発手順/4_SQL実行の安全設計(実装レベル).md](開発手順/4_SQL実行の安全設計(実装レベル).md)

---

## 8. シーケンス（主要フロー）

### 8.1 クエリ実行（Widget表示）
```text
User → Frontend(WidgetContent): useQueryで`POST /execute`
Frontend → API(Execute): queryId取得 → SQL/params展開
API(Execute) → Security: SELECT限定/危険語チェック/LIMIT挿入
API(Execute) → DB: prepared query実行（timeout付き）
DB → API: rows返却
API → Frontend: { columns, rows }
Frontend → Renderer: chart/table描画
```

### 8.2 CSVアップロード → 即可視化
```text
User → Frontend(Upload): CSV選択
Frontend → API(CSV): multipartアップロード
API(CSV) → 型推定/テーブル作成（csv_schema）/COPY投入
API(CSV) → Queries: サンプルSQL自動登録（queryId生成）
API(CSV) → Widgets: 新規widget作成（widgetId応答）
Frontend → Dashboard: 新規widgetを自動配置し表示
```

---

## 9. UI設計（主要画面）

- DashboardList: ダッシュボード一覧/新規作成
- DashboardDetail: `react-grid-layout`でウィジェット配置/リサイズ、ヘッダに再実行・設定
- Upload: CSV選択→プレビュー→型確認→アップロード成功でダッシュボード遷移
- QueryEditor（MVPでは簡易）: `name/sql/parameters` の編集と保存

- フィルタUI
  - Dashboardスコープに `from/to/category` 等を保持 → Widgetの`useQuery`キーに含めて自動再実行

---

## 10. エラー・例外設計

- バリデーション: DTOで必須項目チェック
- 共通エラー形式: `{ error: { code, message } }`
- 主なコード
  - 400: パラメータ不備/不正SQL
  - 401: 認証失敗
  - 403: 権限不足（将来）
  - 408: タイムアウト
  - 429: 行数制限超過
  - 500: 予期せぬ障害（ログ出力）

---

## 11. 設定・環境変数

- Backend
  - `DATABASE_URL`
  - `JWT_SECRET`
  - `READONLY_DB_USER`（必要に応じ）
  - `EXECUTE_TIMEOUT_MS`（例: 5000）
  - `MAX_RESULT_ROWS`（例: 10000）
- Frontend
  - `VITE_API_URL`

- 秘匿情報は環境変数、接続情報は暗号化保存。

---

## 12. ロギング・メトリクス

- `query_executions(query_id, executed_at, duration_ms, row_count)` を保存
- エラーはAPIで集約ログ出力（レベル: error）
- 将来的に tenantごとの使用量集計に活用（[開発手順/7_SaaS化を見据えた最小設計.md](開発手順/7_SaaS化を見据えた最小設計.md)）

---

## 13. 非機能設計

- 性能: 接続プール、LIMIT必須、重いクエリはログで可視化
- 可用性: デモ用途前提。PaaS構成で最低限の安定性確保（[開発手順/10_リリース＆運用の最小手順.md](開発手順/10_リリース＆運用の最小手順.md)）
- 拡張性: `tenant_id` を主要テーブルへ追加可能な設計（今は単一テナント）

---

## 14. デプロイ/開発運用（MVP）

- 開発: DockerでPostgreSQL起動、Backend(3000)/Frontend(5173)
- デプロイ推奨: Frontend=Vercel, Backend=Fly.io/Railway, DB=Managed PostgreSQL
- デモ: サンプルCSV/初期ダッシュボード同梱、`docker compose up` で即起動（[開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md](開発手順/5_MVP実装テンプレ(NestJS + React_repo構成).md)）

---

## 15. 受入観点（基本設計の完了条件）

- API/UI/DBのインターフェースが確定し、MVPの「作れる」状態が明確
- 安全設計（SELECT限定/プリペアド/LIMIT/timeout/readonly）が設計に反映
- CSVアップロードのUX/テーブル作成/サンプルSQL登録フローが定義済み
- 章立てに抜け漏れがなく、要件を満たす構造になっている

---

以上。実装は `execute` モジュールの完成を起点に、Widget→Dashboard→CSVの順で進めるのが最短です。